var fIID = 0;
var interval = 1;
var $cookie = function(){};
var container = ".umf-product-container";
var umf = {option:{price_min_f:0,price_max_f:0,price_slide:false}};
jQuery.fn.exists = function(){return this.length > 0;}
/**
 * fixs for IE
 */
if (!Array.prototype.indexOf) {
  Array.prototype.indexOf = function(obj, start) {
    for (var i = (start || 0), j = this.length; i < j; i++) {
      if (this[i] === obj) {
        return i;
      }
    }
    return -1;
  }
}
function escapeHtml(text) {
  return text
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;");
}
String.prototype.hashCode = function(){
  var hash = 0, i, ch;
  if (this.length == 0) return hash;
  for (i = 0; i < this.length; i++) {
    ch = this.charCodeAt(i);
    hash = ((hash<<5)-hash)+ch;
    hash = hash & hash; // Convert to 32bit integer
  }
  return hash;
};
var tag_tmpl = $.template(null, '<tr><td><input id="tag_${tag}" class="filtered" type="checkbox" name="tags[]" value="${tag}" {{if checked}} checked="checked" {{/if}}></td>' + '<td><label for="tag_${tag}">${name}</label></td></tr>');
var cat_tmpl = $.template(null, '<tr><td><input id="cat_${category_id}" class="filtered" type="checkbox" name="categories[]" value="${category_id}" {{if checked}} checked="checked" {{/if}}></td>' + '<td><label for="cat_${category_id}">${name} <span class="ffilter-counter">${total}</span></label></td></tr>');
$(document).delegate(".price_limit", 'change', function () {
  var b = parseInt($("#min_price").val());
  var a = parseInt($("#max_price").val());
  $("#slider-range").slider("values", [b, a]);
  umf.option.price_min_f = b;
  umf.option.price_max_f = a;
  umf.option.price_slide = true;
  iF();
  return false;
});
function synchronizeImgCheckboxes() {
  $("#ultimatemegafilter input.filtered[type=\"checkbox\"]", "#ultimatemegafilter_box").each(function() {
    var $img = $(this).next('img');
    if ($img.exists()) {
      if ($(this).is(":checked")) {
        $img.addClass("selected");
      } else {
        $img.removeClass("selected");
      }
    }
  });
  return false;
}
$(function () {    
    $("#slider-range", "#ultimatemegafilter_box").slider({range:true, min:0, max:0, values:[0, 0], stop:function (a, b) {
        iF()
    }, slide:function (a, b) {
        umf.option.price_min_f = b.values[0];
        umf.option.price_max_f = b.values[1];
        umf.option.price_slide = true;
        $("#min_price", "#ultimatemegafilter_box").val(b.values[0]);
        $("#max_price", "#ultimatemegafilter_box").val(b.values[1]);
    }});
    $("#min_price", "#ultimatemegafilter_box").val($("#slider-range", "#ultimatemegafilter_box").slider("values", 0));
    $("#max_price", "#ultimatemegafilter_box").val($("#slider-range", "#ultimatemegafilter_box").slider("values", 1));
    
    /**Inline Search By Ashvin Patel**/
    $('.isearch input[type="text"]', "#ultimatemegafilter_box").keyup(function(e){
       var search = this.value;
       search = search.toLowerCase();
       search = search.replace(/\s+/g,' ').trim();       
       var elem = $(this);
       elem.parents('.isearch', "#ultimatemegafilter_box").next().find('tr').addClass('hide')
       elem.parents('.isearch', "#ultimatemegafilter_box").next().find('tr').each(function(){
        var l_text = $(this).find('td:eq(1)').find('label').text();
        l_text = l_text.toLowerCase();
        l_text = l_text.replace(/\s+/g,' ').trim();      
        if(l_text.indexOf(search) !== -1){
            $(this).removeClass('hide');
        }
       });
       return false;
    })
    /**End**/
});
function iF() {
    clearTimeout(fIID);
    $("#ultimatemegafilter_page", "#ultimatemegafilter_box").val(1);
    fIID = setTimeout("doFilter(false)", interval)
}
function success(g, b) {
    if (g.result_html) {
        if(g.result_html.list && g.result_html.grid){
            $(".umf-product-container").html(g.result_html.list);
            $(".umf-product-container").html(g.result_html.grid);
        } else {
            $(".umf-product-container").html(g.result_html);
        }
        if (localStorage.getItem('display') == 'list') {
            $('#list-view').trigger('click');
        } else {
            $('#grid-view').trigger('click');
        }
        $('#list-view').click(function() {
            $('#content .product-layout > .clearfix').remove();
            $('#content .product-layout').attr('class', 'product-layout product-list col-xs-12'); 
            localStorage.setItem('display', 'list');
        });
        afterload();
    }

    if(g.allow_pag){
        if (g.pagination){
            $(".pagination").html(g.pagination);
        }else{
            $(".pagination").html('');
        }
        if (g.result){
            $(".pagination_result").html(g.result);
        }else{
            $(".pagination_result").html('');
        }
    }
    if (b) {        
        umf.option.price_min = parseInt(g.min_price);
        umf.option.price_max = parseInt(g.max_price);
        umf.option.price_min_f = parseInt(g.min_price);
        umf.option.price_max_f = parseInt(g.max_price);
    }   
    if (g.allow_pag) {
        var d = parseInt(g.min_price);
        var c = parseInt(g.max_price);
        $("#slider-range", "#ultimatemegafilter_box").slider("option", {min:d, max:c});
        if(c != d){
            if ($("#max_price", "#ultimatemegafilter_box").val() >= 1) {
                var d1 = parseInt($("#min_price", "#ultimatemegafilter_box").val());
                var c1 = parseInt($("#max_price", "#ultimatemegafilter_box").val());
                if( d1 < umf.option.price_min) {
                    d1 = umf.option.price_min;
                }                
                if( c1 > umf.option.price_max ) {
                    c1 = umf.option.price_max;
                }
                if( d1 > c1 ) {
                    d1 = c1;
                }
                if(d1 < d){
                    d1 = d;
                }
                if(c1 > c){
                    c1 = c;
                }
            }else{
                var d1 = d;
                var c1 = c;
            }
        }else{
            var d1 = d;
            var c1 = c;
        }   
        if(!umf.option.price_slide){
            $("#slider-range", "#ultimatemegafilter_box").slider("option", {values:[d1, c1]});
            $("#min_price", "#ultimatemegafilter_box").val(d1);
            $("#max_price", "#ultimatemegafilter_box").val(c1);
        }
    }
    if (g.totals_data) {
        /*if (g.totals_data.tags.length) {
            $('#filter_tags').html('');
            $.tmpl(tag_tmpl, g.totals_data.tags).appendTo('#filter_tags');
            $('#filter_tags').parents('.option_box').show();
        } else {
            $('#filter_tags').parents('.option_box').hide();
        }*/

        $('#filter_categories', "#ultimatemegafilter_box").html('');
        if (g.totals_data.categories.length) {
            $.tmpl(cat_tmpl, g.totals_data.categories).appendTo('#filter_categories', "#ultimatemegafilter_box");
            $('#filter_categories', "#ultimatemegafilter_box").parents('.option_box', "#ultimatemegafilter_box").show();
        } else {
            $('#filter_categories', "#ultimatemegafilter_box").parents('.option_box', "#ultimatemegafilter_box").hide();
        }

        var atts = {};       

        var  attributes = g.totals_data.attributes;
        for (var i = 0; i < g.totals_data.attributes.length; i++) {
            if(attributes[i]){
                var v = attributes[i];
                atts[(v.id + "_" + v.text).replace(/\s/g, '_')] = v.t;
            }
        };        
        for (var i = 0; i < $('.a_name', "#ultimatemegafilter_box").length; i++) {
            var v = $('.a_name', "#ultimatemegafilter_box")[i];
            var at_v_i = $(v).attr('at_v_i').replace(/\s/g, '_');           
            var at_v_i_e = escapeHtml(at_v_i);
            if (atts[at_v_i]) {
                $('[at_v_t="' + at_v_i_e + '"]').html($('[at_v_t="' + at_v_i_e + '"]').attr('data-value') + " <span class='ffilter-counter'>" + atts[at_v_i] + "</span>");
                $(v).removeAttr("disabled");
            } else {
                $('[at_v_t="' + at_v_i_e + '"]').text($('[at_v_t="' + at_v_i_e + '"]').attr('data-value'));
                $(v).attr("disabled", "disabled");
                $(v).removeAttr('checked');
                $(v).removeAttr(':selected');
            }
        };        

        var h = [];
        var manufacturers = g.totals_data.manufacturers; 
        for (var i = 0; i < g.totals_data.manufacturers.length; i++) {            
            var k = manufacturers[i];
            if (k.id) {
                h[h.length] = k.id;
                var j = $("#manufacturer_" + k.id, "#ultimatemegafilter_box");
                if (j.length == 0) {
                    continue;
                }
                j.removeAttr("disabled");
                if (j.get(0).tagName == "OPTION") {
                    j.text($("#m_" + k.id, "#ultimatemegafilter_box").val() + " (" + k.t + ")")
                } else {
                    $('label[for="manufacturer_' + k.id + '"]', "#ultimatemegafilter_box").html($("#m_" + k.id, "#ultimatemegafilter_box").val() + " <span class='ffilter-counter'>" + k.t + "</span>")
                }
            }
        };         
        for(var i = 0;i < $(".manufacturer_value", "#ultimatemegafilter_box").length;i++){
            var j = $($(".manufacturer_value", "#ultimatemegafilter_box")[i]);            
            var l = j.attr("id").match(/manufacturer_(\d+)/);
            if ($.inArray(l[1], h) < 0) {
                j.attr("disabled", "disabled");
                if (this.tagName == "OPTION") {
                    j.text($("#m_" + l[1], "#ultimatemegafilter_box").val());
                    j.prop("selected", false)
                } else {
                    $('label[for="manufacturer_' + l[1] + '"]').text($("#m_" + l[1], "#ultimatemegafilter_box").val());
                    j.prop("checked", false)
                }
            }
        }        

        var r = [];        
        var rratings = g.totals_data.rrating;         
        for (var i = 0; i < g.totals_data.rrating.length; i++) {                        
            var k = rratings[i];            
            if (k.id) {                
                r[r.length] = k.id;                
                var j = $("#rrating_" + k.id, "#ultimatemegafilter_box");                
                if (j.length == 0) {                    
                    continue;                
                }                
                j.removeAttr("disabled");                
                if (j.get(0).tagName == "OPTION") {                    
                    j.text($("#r_" + k.id, "#ultimatemegafilter_box").val() + " (" + k.t + ")")                
                } else {                    
                    if($('label[for="rrating_' + k.id + '"]', "#ultimatemegafilter_box").parents('.ultimatemegafilter_imagetype').length){  
                        $('label[for="rrating_' + k.id + '"]', "#ultimatemegafilter_box").html("<span class='ffilter-counter'>" + k.t + "</span>")                    
                    }else{                       
                        $('label[for="rrating_' + k.id + '"]', "#ultimatemegafilter_box").html($("#r_" + k.id, "#ultimatemegafilter_box").val() + " <span class='ffilter-counter'>" + k.t + "</span>")                    
                    }                
                }            
            }        
        };                 
        for(var i = 0;i < $(".rrating_value", "#ultimatemegafilter_box").length;i++){            
            var j = $($(".rrating_value", "#ultimatemegafilter_box")[i]);                        
            var l = j.attr("id").match(/rrating_(\d+)/);            
            if ($.inArray(l[1], r) < 0) {                
                j.attr("disabled", "disabled");                
                if (this.tagName == "OPTION") {                    
                    j.text($("#r_" + l[1], "#ultimatemegafilter_box").val());                    
                    j.prop("selected", false)                
                } else {                    
                    if(!$('label[for="rrating_' + l[1] + '"]').parents('.ultimatemegafilter_imagetype').length){                        
                        $('label[for="rrating_' + l[1] + '"]').text($("#r_" + l[1], "#ultimatemegafilter_box").val());                    
                    }                    
                    j.prop("checked", false)                
                }            
            }        
        }


        var pk = [];
        var payment_methods = g.totals_data.payment_methods;        
        for (var i = 0; i < g.totals_data.payment_methods.length; i++) {
            var k = payment_methods[i];
            if (k.id) {
                pk[pk.length] = k.id;
                var j = $("#pmethod_value_" + k.id, "#ultimatemegafilter_box");
                if (j.length == 0) {
                    continue;
                }
                j.removeAttr("disabled");
                if (j.get(0).tagName == "OPTION") {
                    j.text($("#pm_" + k.id, "#ultimatemegafilter_box").val() + " (" + k.t + ")")
                } else {
                    $('label[for="pmethod_value_' + k.id + '"]', "#ultimatemegafilter_box").html($("#pm_" + k.id, "#ultimatemegafilter_box").val() + " <span class='ffilter-counter'>" + k.t + "</span>")
                }
            }
        };        
        for (var i = 0; i < $(".pmethod_value", "#ultimatemegafilter_box").length; i++) {
            var j = $($(".pmethod_value", "#ultimatemegafilter_box")[i]);
            var l = j.attr("id").match(/pmethod_value_([a-z_]+)/);            
            if ($.inArray(l[1], pk) < 0) {
                j.attr("disabled", "disabled");
                if (this.tagName == "OPTION") {
                    j.text($("#pm_" + l[1], "#ultimatemegafilter_box").val());
                    j.prop("selected", false)
                } else {
                    $('label[for="pmethod_value_' + l[1] + '"]').text($("#pm_" + l[1], "#ultimatemegafilter_box").val());
                    j.prop("checked", false)
                }
            }
        };

        var sk = [];        
        var shipping_methods = g.totals_data.shipping_methods;
        for (var i = 0; i < g.totals_data.shipping_methods.length; i++) {
            var k = shipping_methods[i];
            if (k.id) {
                sk[sk.length] = k.id;
                var j = $("#smethod_value_" + k.id, "#ultimatemegafilter_box");
                if (j.length == 0) {
                    continue;
                }
                j.removeAttr("disabled");
                if (j.get(0).tagName == "OPTION") {
                    j.text($("#sm_" + k.id, "#ultimatemegafilter_box").val() + " (" + k.t + ")")
                } else {
                    $('label[for="smethod_value_' + k.id + '"]', "#ultimatemegafilter_box").html($("#sm_" + k.id, "#ultimatemegafilter_box").val() + " <span class='ffilter-counter'>" + k.t + "</span>")
                }
            }
        };
        for (var i = 0; i < $(".smethod_value", "#ultimatemegafilter_box").length; i++) {
            var j = $($(".smethod_value", "#ultimatemegafilter_box")[i]);
            var l = j.attr("id").match(/smethod_value_([a-z]+)/);            
            if ($.inArray(l[1], sk) < 0) {
                j.attr("disabled", "disabled");
                if (this.tagName == "OPTION") {
                    j.text($("#sm_" + l[1], "#ultimatemegafilter_box").val());
                    j.prop("selected", false)
                } else {
                    $('label[for="smethod_value_' + l[1] + '"]', "#ultimatemegafilter_box").text($("#sm_" + l[1], "#ultimatemegafilter_box").val());
                    j.prop("checked", false)
                }
            }
        };  


        var ss = [];        
        var stock_status = g.totals_data.stock_status;        
        for (var i = 0; i < stock_status.length; i++) {           
            var k = stock_status[i];
            if (k.id) {
                ss[ss.length] = k.id;
                var j = $("#stock_status_" + k.id, "#ultimatemegafilter_box");
                if (j.length == 0) {
                    continue;
                }
                j.removeAttr("disabled");
                if (j.get(0).tagName == "OPTION") {
                    j.text($("#ss_" + k.id, "#ultimatemegafilter_box").val() + " (" + k.t + ")")
                } else {
                    $('label[for="stock_status_' + k.id + '"]', "#ultimatemegafilter_box").html($("#ss_" + k.id, "#ultimatemegafilter_box").val() + " <span class='ffilter-counter'>" + k.t + "</span>")
                }
            }
        };
        for (var i = 0; i < $(".stock_status", "#ultimatemegafilter_box").length; i++) {
            var j = $($(".stock_status", "#ultimatemegafilter_box")[i]);
            var l = j.attr("id").match(/stock_status_(\d+)/);            
            if ($.inArray(l[1], ss) < 0) {
                j.attr("disabled", "disabled");
                if (this.tagName == "OPTION") {
                    j.text($("#ss_" + l[1], "#ultimatemegafilter_box").val());
                    j.prop("selected", false)
                } else {
                    $('label[for="stock_status_' + l[1] + '"]', "#ultimatemegafilter_box").text($("#ss_" + l[1], "#ultimatemegafilter_box").val());
                    j.prop("checked", false)
                }
            }
        };
        
        var e = [];       
        var options = g.totals_data.options;
        for (var i = 0; i < g.totals_data.options.length; i++) {
            var k = options[i]; 
            if (k.id) {
                e[e.length] = k.id;
                var f = $("#option_value_" + k.id, "#ultimatemegafilter_box");
                if (f.exists()) {
                    f.removeAttr("disabled");
                    if (f.get(0).tagName == "OPTION") {
                        f.text($("#o_" + k.id, "#ultimatemegafilter_box").val() + " (" + k.t + ")")
                    } else {
                        $('label[for="option_value_' + k.id + '"]', "#ultimatemegafilter_box").html($("#o_" + k.id, "#ultimatemegafilter_box").val() + " <span class='ffilter-counter'>" + k.t + "</span>")
                    }
                }
            }
        };
        for (var i = 0; i < $(".option_value", "#ultimatemegafilter_box").length; i++) {
            var f = $($(".option_value", "#ultimatemegafilter_box")[i]);
            var l = f.attr("id").match(/option_value_(\d+)/);
            if ($.inArray(l[1], e) < 0) {
                f.attr("disabled", "disabled");
                if (this.tagName == "OPTION") {
                    f.text($("#o_" + l[1], "#ultimatemegafilter_box").val());
                    f.attr("selected", false)
                } else {
                    $('label[for="option_value_' + l[1] + '"]', "#ultimatemegafilter_box").text($("#o_" + l[1], "#ultimatemegafilter_box").val());
                    f.attr("checked", false)
                }
            }
        };        

        /**Product Filter Count**/
        var pf = [];        
        var filters = g.totals_data.filters;
        for (var i = 0; i < g.totals_data.filters.length; i++) {
            var k = filters[i];
            if (k.id) {
                pf[pf.length] = k.id;
                var f = $("#filter_value_" + k.id, "#ultimatemegafilter_box");                
                if (f.exists()) {
                    f.removeAttr("disabled");
                    if (f.get(0).tagName == "OPTION") {
                        f.text($("#f_" + k.id, "#ultimatemegafilter_box").val() + " (" + k.t + ")")
                    } else {
                        $('label[for="filter_value_' + k.id + '"]').html($("#f_" + k.id, "#ultimatemegafilter_box").val() + " <span class='ffilter-counter'>" + k.t + "</span>")
                    }
                }
            }
        };
        for (var i = 0; i < $(".filter_value", "#ultimatemegafilter_box").length; i++) {
            var f = $($(".filter_value", "#ultimatemegafilter_box")[i]);
            var l = f.attr("id").match(/filter_value_(\d+)/);
            if ($.inArray(l[1], pf) < 0) {
                f.attr("disabled", "disabled");
                if (this.tagName == "OPTION") {
                    f.text($("#f_" + l[1], "#ultimatemegafilter_box").val());
                    f.attr("selected", false)
                } else {
                    $('label[for="filter_value_' + l[1] + '"]', "#ultimatemegafilter_box").text($("#f_" + l[1], "#ultimatemegafilter_box").val());
                    f.attr("checked", false)
                }
            }
        };        
    }
    umf.option.price_slide = false;
    showInlClear();
}
function showInlClear(){
    $('.option_box').each(function(){
        var box_elem = $(this);
        if(box_elem.find('input[type="checkbox"]:checked').length){
            box_elem.find('.umf-inl-clear').show();
        }else if(box_elem.find('input[type="radio"]:checked').length){
            box_elem.find('.umf-inl-clear').show();
        }else if(box_elem.find('select').val()){
            box_elem.find('.umf-inl-clear').show();
        }else{
            box_elem.find('.umf-inl-clear').hide();
        }

        if(box_elem.find('.price_slider').length){
            var min_price = umf.option.price_min;
            var max_price = umf.option.price_max;
            if($('#min_price').val() == min_price && $('#max_price').val() == max_price){
                box_elem.find('.umf-inl-clear').hide();
            }else{
                box_elem.find('.umf-inl-clear').show();
            }
        }
    });
}
function getCont(){
  /*if ($cookie){
    var view = $cookie("display");
  } */
}
var cache = [];
var cache1 = [];
function doFilter(b) {
    $('html, body').animate({ scrollTop: $("body").offset().top }, 'slow');
    var a = $("#ultimatemegafilter").serialize().replace(/[^&]+=\.?(?:&|$)/g, "").replace(/&+$/, "");
    var search = $('#content input[name=\'search\']').attr('value');    
    if (search) {
      a += '&search=' + encodeURIComponent(search);
    }
    var category_id = $('#content select[name=\'category_id\']').attr('value');    
    if (category_id > 0) {
      a += '&category_id=' + encodeURIComponent(category_id);
    }    
    var sub_category = $('#content input[name=\'sub_category\']:checked').attr('value');    
    if (sub_category) {
      a += '&sub_category=true';
    }        
    var filter_description = $('#content input[name=\'description\']:checked').attr('value');    
    if (filter_description) {
      a += '&description=true';
    }
    if(window.attributes){
        a += '&attributes='+window.attributes.join(',');
    }
    if(window.stock_status_ids){
        a += '&stock_status_ids='+window.stock_status_ids.join(',');
    }

    a += '&category_count='+category_count+'&manufacturer_count='+manufacturer_count;
    a += '&option_count='+option_count+'&filter_count='+filter_count+'&payment_count='+payment_count+'&shipping_count='+shipping_count;
    
    if($('#min_price').length){
        a += '&min_price='+umf.option.price_min_f;
        a += '&max_price='+umf.option.price_max_f;
    }

    if (!b) {
        window.location.hash = a
    }
    var h = a.hashCode();
    if (cache[h]){
        success(cache[h]);
    } else {
        $.ajax({
            url:"index.php?route=module/ultimatemegafilter/getproducts", 
            type:"POST", 
            data:a + (b ? "&getPriceLimits=true" : ""), 
            dataType:"json",
            beforeSend: function(){
              $("#content").mask();
            },
            success:function (g) {
              success(g, b);
              cache[h] = g;                
              $("#content").unmask();
            },
            error:function(jqXHR, textStatus, errorThrown) {                
              $("#content").unmask();            
            }
        });
    }

    if (cache1[h]){
        success(cache1[h]);
    } else {
        //Get Totals
        $.ajax({
            url:"index.php?route=module/ultimatemegafilter/getProductsTotal", 
            type:"POST", 
            data:a + (b ? "&getPriceLimits=true" : ""), 
            dataType:"json",            
            success:function (g) {
                success(g);
                cache1[h] = g; 
            },
            error:function(jqXHR, textStatus, errorThrown) {
            }
        });
    }
}
$(document).ready(function () {
    if ($('#ultimatemegafilter_container', "#ultimatemegafilter_box").exists()){
        container = $('#ultimatemegafilter_container', "#ultimatemegafilter_box").val();
    }
    if ($.totalStorage != undefined && $.totalStorage('display') != null) {
        $cookie = $.totalStorage;
    } else if ($.cookie != undefined && $.cookie('display') != null) {
        $cookie = $.cookie;
    }
    $(".umf-inl-clear").click(function(e){
        e.preventDefault();

        var elem = $(this);
        if(elem.parent().parent(".col-sm-3").length){
            elem.parent().parent().next().find('input[type="checkbox"]').prop('checked', false);
            elem.parent().parent().next().find('input[type="radio"]').prop('checked', false);
            elem.parent().parent().next().find('img').removeClass('selected');
            elem.parent().parent().next().find('select').val('');
            if(elem.parent().parent().next().find('.price_slider').length){
            var b = umf.option.price_min;
            var a = umf.option.price_max;
            umf.option.price_min_f = b;
            umf.option.price_max_f = a;
            $("#slider-range", "#ultimatemegafilter_box").slider("option", {values:[b, a]});
            $("#min_price", "#ultimatemegafilter_box").val(b);
            $("#max_price", "#ultimatemegafilter_box").val(a);
        }
        iF();
        }else{
            elem.parent().next().find('input[type="checkbox"]').prop('checked', false);
            elem.parent().next().find('input[type="radio"]').prop('checked', false);
            elem.parent().next().find('img').removeClass('selected');
            elem.parent().next().find('select').val('');
            if(elem.parent().next('.price_slider').length){
            var b = umf.option.price_min;
            var a = umf.option.price_max;
            umf.option.price_min_f = b;
            umf.option.price_max_f = a;
            $("#slider-range", "#ultimatemegafilter_box").slider("option", {values:[b, a]});
            $("#min_price", "#ultimatemegafilter_box").val(b);
            $("#max_price", "#ultimatemegafilter_box").val(a);
        }
        iF();
        }

        
    });
    $("body").on("click", ".pagination a", (function (e) {
      e.preventDefault();
      var a = $(this).attr("href");
      var b = a.match(/page=(\d+)/);
      $("#ultimatemegafilter_page", "#ultimatemegafilter_box").val(b[1]);
      doFilter(false);        
      $('html, body').animate({ scrollTop: $(".umf-product-container").offset().top }, 'slow');
      return false;
    }));
    if($("#input-sort").exists()){
      $("#input-sort").get(0).onchange = null;
      $("#input-sort").change(function () {
        var d = $(this).val();
        var a = gUV(d, "sort");
        var b = gUV(d, "order");
        $("#ultimatemegafilter_sort").val(a);
        $("#ultimatemegafilter_order").val(b);
        iF();
        return false;
      });
    }

    if ($("#input-limit").exists()) {
      $("#input-limit").get(0).onchange = null;
      $("#input-limit").change(function () {
        $("#ultimatemegafilter_limit", "#ultimatemegafilter_box").val(gUV($(this).val(), "limit"));
        iF();
        return false;
      });
    }
    // deserialize
    var hash = window.location.hash.substr(1);
    if (hash && $('instock').is(':visible') && $('instock').is(':checked')) {
      $('instock').attr("checked", false);
    }
    $("#ultimatemegafilter", "#ultimatemegafilter_box").deserialize(hash);
    synchronizeImgCheckboxes();
    $("#ultimatemegafilter img", "#ultimatemegafilter_box").bind("click", function() {
        var $input = $(this).prev("input");
        if ($input.attr("disabled")) {
          return;
        }
        $(this).toggleClass("selected");
        $input.prop('checked', !$input.prop('checked'));
        iF();
        return false;
    });


    $("div[id^=slider-range-]", "#ultimatemegafilter_box").each(function(index, element) {
    	var id = this.id.replace(/[^\d]/g, '');
    	var arr = window['attr_arr_'+id];

    	var b = parseInt($("#attribute_value_"+id+"_min", "#ultimatemegafilter_box").val());
    	var a = parseInt($("#attribute_value_"+id+"_max", "#ultimatemegafilter_box").val());
    	b = arr.indexOf(b);
    	a = arr.indexOf(a);
    	if (a >= 0 && b >= 0){
    	    hs = $(element).slider();
    	    hs.slider("option", {values:[b, a]});
    	    hs.slider("option","slide").call(hs, null, { handle: $(".ui-slider-handle", hs), values:[b, a] });
    	}
        return false;
    });

    if ($("#input-sort").exists()) {
        if ($("#ultimatemegafilter_sort", "#ultimatemegafilter_box").val()) {
            $("#input-sort option").each(function(i, e) {
                if (gUV($(this).val(), "sort") == $("#ultimatemegafilter_sort", "#ultimatemegafilter_box").val() && gUV($(this).val(), "order") == $("#ultimatemegafilter_order", "#ultimatemegafilter_box").val()) {
                    $(".sort select").val($(this).val());
                    return;
                }
                return false;
            });
        } else {
            $val = $("#input-sort").val();
            $("#ultimatemegafilter_sort", "#ultimatemegafilter_box").val(gUV($val, "sort"));
            $("#ultimatemegafilter_order", "#ultimatemegafilter_box").val(gUV($val, "order"))
        }
    }
    if ($("#input-limit").exists()) {
        if ($("#ultimatemegafilter_limit", "#ultimatemegafilter_box").val()) {
		$("#input-limit option").each(function(i, e) {
			if (gUV($(this).val(), "limit") == $("#ultimatemegafilter_limit", "#ultimatemegafilter_box").val()) {
			    $(this).attr('selected', 'selected');
			    return;
			}
            return false;
		});
        } else {
            $("#ultimatemegafilter_limit", "#ultimatemegafilter_box").val(gUV($("#input-limit").val(), "limit"));
        }
    }    
    if($("#ultimatemegafilter_box").length){
      doFilter(true);
    }
});
$(document).delegate('.option_box .option_name', 'click', function(e){
  if(!$(e.target).hasClass('umf-inl-clear')){  
        $(this).siblings(".collapsible").slideToggle(400);
        $(this).toggleClass("hided");
        return false;
        }
});
$(document).delegate('.option_box .attribute_group_name', 'click', function(){
  $(this).siblings(".attribute_box").slideToggle(400);
  $(this).toggleClass("hided");
  return false;
});
$(document).delegate("input[id='description'], input[name='search'], input[id='sub_category'], select[name='category_id']", "change", (function () {
  iF();
  return false;
}));
$(document).delegate(".filtered", "change", (function () {
  iF();
  return false;
}));
$(document).delegate(".clear_filter", 'click', function () {
    $("#ultimatemegafilter img", "#ultimatemegafilter_box").removeClass("selected");
    $("#ultimatemegafilter select", "#ultimatemegafilter_box").val("");
    $("#ultimatemegafilter :input", "#ultimatemegafilter_box").each(function () {
      if ($(this).is(":checked")) {
        $(this).attr("checked", false)
      }
    });
    var b = umf.option.price_min;
    var a = umf.option.price_max;
    umf.option.price_min_f = b;
    umf.option.price_max_f = a;
    $("#slider-range", "#ultimatemegafilter_box").slider("option", {values:[b, a]});
    $("#min_price", "#ultimatemegafilter_box").val(b);
    $("#max_price", "#ultimatemegafilter_box").val(a);

    $("div[id^=slider-range-]", "#ultimatemegafilter_box").each(function(index, element) {
        var id = this.id.replace(/[^\d]/g, '');

        var b = $(element).slider("option", "min");
        var a = $(element).slider("option", "max");
        
        hs = $(element).slider();
        hs.slider("option", {values:[b, a]});
        hs.slider("option","slide").call(hs, null, { handle: $(".ui-slider-handle", hs), values:[b, a] });

        $("#attribute_value_"+id+"_min", "#ultimatemegafilter_box").val('');
        $("#attribute_value_"+id+"_max", "#ultimatemegafilter_box").val('');
    });
    iF();
    return false;
});
function gUV(e,f){var c=String(e).split("?");var a="";if(c[1]){var b=c[1].split("&");for(var g=0;g<=(b.length);g++){if(b[g]){var d=b[g].split("=");if(d[0]&&d[0]==f){a=d[1]}}}}return a}